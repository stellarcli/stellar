#!/usr/bin/env bash
export STELLAR_PATH="$( cd "$(dirname "$0")" ; pwd -P )"
export CURRENT_UID=$(id -u):$(id -g)

find_up () {
  path=$(pwd)
  while [[ "$path" != "" && ! -e "$path/$1" ]]; do
    path=${path%/*}
  done
  echo "$path"
}

init() {
    if [[ -f ".stellar-env" ]]; then
        export BACKEND_PATH="$( pwd -P)"
    else
        export BACKEND_PATH="$( find_up  .stellar-env )"
    fi
    set -a
        source "${BACKEND_PATH}/.stellar-env"
    set +a
    if [[ $# -gt 0 ]]; then
        start_command "${@}"
    else
        echo "init                 Init Stellar."
        echo "start                Start Stellar."
        echo "artisan              Pass through command to php artisan."
        echo "test                 Run phpunit tests."
    fi
}

start_command() {
    if [[ ${1} == "init" ]]; then
        run_command docker-compose up -d web
        dcr artisan migrate:fresh --seed
        dcr phpunit
    elif [[ "${1}" == "refresh" ]]; then
        run_command docker-compose down
        run_command docker-compose up -d web
        dcr artisan migrate:refresh --seed
        dcr phpunit
    elif [[ "${1}" == "start" ]]; then
        run_command docker-compose up -d web
        dcr artisan migrate
    elif [[ "${1}" == "artisan" ]]; then
        shift 1
        dcr artisan "${@}"
    elif [[ "${1}" == "test" ]]; then
    shift 1
        dcr  phpunit "${@}"
    elif [[  $# -gt 0 ]]; then
        run_command docker-compose "${@}"
    fi
    exit 0
}

dcr() {
    run_command docker-compose run --rm  "${@}"
}

run_command() {
  if [[ $# -gt 0 ]]; then
    (cd ${STELLAR_PATH}  && $*)
  fi
}

init "${@}"
